<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unemployment's Quest - Edisi Himmel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --himmel-blue-darkest: #1a2c4e;
            --himmel-blue-darker: #2a4065;
            --himmel-blue-dark: #3b5998;
            --himmel-blue-medium-dark: #4a69a5;
            --himmel-blue-primary: #70a1ff;
            --himmel-blue-lighter: #a3c1ff;
            --himmel-blue-lightest: #e0e8ff;
            --text-color-light: #f0f8ff; 
            --text-color-dim: #c0d8ff;
            --pixel-font: 'Press Start 2P', cursive;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--himmel-blue-darkest); 
            background-image: url('https://i.imgur.com/jKpfaLW.jpeg');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            color: var(--text-color-light); 
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(
                135deg, 
                rgba(26, 44, 78, 0.98) 0%, 
                rgba(26, 44, 78, 0.90) 25%,
                rgba(42, 64, 101, 0.80) 60%, 
                rgba(74, 105, 165, 0.70) 100% 
            );
            z-index: -1;
        }

        .font-pixel {
            font-family: var(--pixel-font);
            text-transform: uppercase; 
            letter-spacing: 1px;
        }

        .top-header {
            background-color: var(--himmel-blue-dark); 
            padding: 0.75rem 1.5rem; 
            position: relative;
            z-index: 20;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .logo-text {
            font-size: 1.1rem; 
            font-weight: normal; 
            color: white;
        }
        
        .capsule-button-modern {
            background-color: var(--himmel-blue-primary); 
            color: white;
            border-radius: 9999px;
            padding: 0.6rem 1.35rem; 
            font-size: 0.875rem; 
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
            line-height: 1.25rem; 
            cursor: pointer;
        }
        .capsule-button-modern:hover {
            background-color: #547fcc; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .capsule-button-modern:disabled {
            background-color: var(--himmel-blue-medium-dark);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .capsule-button-secondary {
            background-color: transparent;
            color: var(--himmel-blue-lighter); 
            border: 1px solid var(--himmel-blue-primary);
        }
        .capsule-button-secondary:hover {
            background-color: rgba(112, 161, 255, 0.15); 
            color: white;
        }
        .capsule-button-danger {
            background-color: #e53e3e; 
            color: white;
        }
        .capsule-button-danger:hover {
            background-color: #c53030; 
        }


        .quest-card {
            background-color: rgba(30, 49, 82, 0.95); 
            border-radius: 0.5rem; 
            padding: 1.25rem; 
            border: 1px solid var(--himmel-blue-medium-dark); 
            box-shadow: 0 3px 6px rgba(0,0,0,0.3); 
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
        }
        .quest-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.35);
        }
        .quest-card-content {
            flex-grow: 1; 
        }
        .quest-card-actions {
            margin-top: 0.75rem; 
            display: flex;
            justify-content: flex-end; 
            gap: 0.5rem; 
        }

        .quest-card-icon-wrapper { 
            width: 36px; 
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem; 
            background-color: rgba(112, 161, 255, 0.25); 
            border-radius: 0.375rem; 
        }
        .quest-card-icon-wrapper i {
            font-size: 1rem; 
            color: var(--himmel-blue-lighter); 
        }
        .quest-card h4 { 
             font-size: 0.9rem; 
             line-height: 1.3;
        }
        
        .modal { 
            background-color: rgba(20, 33, 61, 0.92); 
        }
        .modal-content {
            background-color: var(--himmel-blue-darker); 
            border: 1px solid var(--himmel-blue-medium-dark);
            color: var(--text-color-light);
            border-radius: 0.5rem; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.6); 
        }
        .modal-title { 
            font-size: 1rem; 
            font-weight: normal;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; } 
        ::-webkit-scrollbar-thumb { background-color: rgba(74, 105, 165, 0.6); border-radius: 3px; } 
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(112, 161, 255, 0.8); } 
        body { scrollbar-width: thin; scrollbar-color: rgba(74, 105, 165, 0.6) transparent; }

        .quest-type-nav-card { 
            background-color: rgba(42, 64, 101, 0.9); 
            border: 1px solid var(--himmel-blue-medium-dark);
            border-radius: 0.5rem; 
            padding: 0.75rem 1rem; 
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            color: var(--text-color-dim);
            display: flex;
            align-items: center;
            flex-grow: 1; 
            justify-content: center; 
        }
        .quest-type-nav-card:hover, .quest-type-nav-card.active {
            background-color: var(--himmel-blue-primary); 
            color: white;
            border-color: var(--himmel-blue-lighter); 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 4px 10px rgba(112, 161, 255, 0.4); 
        }
        .quest-type-nav-card i {
            margin-right: 0.75rem;
            font-size: 1.125rem; 
        }

        .streak-balls-container {
            display: flex;
            justify-content: center; 
            gap: 0.5rem; 
            margin-bottom: 0.5rem; 
        }
        .streak-ball {
            width: 18px; 
            height: 18px;
            border-radius: 50%;
            background-color: rgba(74, 105, 165, 0.4); 
            border: 1px solid var(--himmel-blue-primary);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .streak-ball.filled { 
            background-color: #00c9ff; 
            box-shadow: 0 0 6px #00c9ff, 0 0 9px #67e3ff;
        }
        .streak-number {
            font-size: 1.25rem; 
            font-weight: 600;
            color: var(--text-color-light);
        }
        .streak-text {
            font-size: 0.75rem; 
            color: var(--himmel-blue-lighter);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .main-content-wrapper {
            padding: 1.5rem; 
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 1200px; 
            margin: 0 auto; 
        }
         @media (min-width: 768px) { 
            .main-content-wrapper {
                padding: 2rem; 
            }
        }

        .profile-pic {
            width: 70px; 
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--himmel-blue-primary);
            box-shadow: 0 0 10px rgba(112, 161, 255, 0.5); 
            cursor: pointer;
        }
        .xp-bar-container { 
            height: 0.5rem; 
            background-color: rgba(74, 105, 165, 0.4); 
            border: 1px solid var(--himmel-blue-primary); 
            width: 100px; 
            border-radius: 9999px;
            overflow: hidden;
        }
        .xp-bar { 
            background-color: var(--himmel-blue-lighter); 
            transition: width 0.5s ease-in-out;
            height: 100%;
            border-radius: 9999px;
        }
        .profile-modal-pic {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--himmel-blue-lighter); 
            margin-bottom: 1rem;
        }
        
        .player-info-section .username { 
            font-size: 1.1rem; 
            line-height: 1.3; 
            word-break: break-word; 
            color: white;
            font-weight: 600;
            cursor: pointer;
             border-bottom: 1px dashed transparent;
        }
        .player-info-section .username:hover {
            border-bottom-color: var(--himmel-blue-lighter);
        }
        .player-info-section .username-edit-input {
            font-size: 1.1rem;
            background-color: rgba(26, 44, 78, 0.8); 
            border: 1px solid var(--himmel-blue-primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            width: 100%;
        }
        .player-info-section .user-id { 
            font-size: 0.7rem;
            color: var(--text-color-dim);
            line-height: 1.2;
            word-break: break-all; 
            margin-top: 0.1rem;
        }
         .player-info-section .user-bio { 
            font-size: 0.8rem;
            color: var(--text-color-light);
            line-height: 1.4;
            margin-top: 0.3rem;
            min-height: 2.8em; 
            cursor: pointer;
            border-bottom: 1px dashed transparent;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .player-info-section .user-bio:hover {
            border-bottom-color: var(--himmel-blue-lighter);
        }
        .player-info-section .bio-edit-input { 
            font-size: 0.8rem;
            background-color: rgba(26, 44, 78, 0.8); 
            border: 1px solid var(--himmel-blue-primary);
            color: white;
            padding: 0.375rem 0.5rem;
            border-radius: 0.25rem;
            width: 100%;
            margin-top: 0.3rem;
            min-height: 60px;
            resize: vertical;
        }

        .level-text { 
            font-size: 0.8rem; 
        }
        #currentQuestTypeTitle { 
            font-size: 1.3rem; 
            margin-top: 1.5rem; 
            margin-bottom: 1rem;
        }
        .quest-list-container {
             max-height: calc(100vh - 430px); 
             overflow-y: auto;
             display: grid;
             gap: 1rem; 
        }
        @media (min-width: 640px) { 
            .quest-list-container { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        }
        @media (min-width: 768px) { 
            .quest-list-container { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }
        @media (min-width: 1024px) { 
             .quest-list-container { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }


        .time-display {
            font-size: 0.8rem;
            color: var(--text-color-dim);
            background-color: rgba(42, 64, 101, 0.5); 
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid var(--himmel-blue-medium-dark);
            margin-top: 0.5rem; 
        }
        .action-button { 
            padding: 0.375rem 0.6rem; 
            border-radius: 0.375rem; 
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.8rem; 
            line-height: 1; 
            background-color: rgba(112, 161, 255, 0.2);
            color: var(--himmel-blue-lighter);
            border: 1px solid rgba(112, 161, 255, 0.4);
        }
        .action-button:hover {
            background-color: rgba(112, 161, 255, 0.4);
            color: white;
        }
        .action-button.complete {
             background-color: rgba(74, 105, 165, 0.7); 
             color: white;
        }
         .action-button.complete:hover {
             background-color: var(--himmel-blue-primary);
        }
        .action-button.delete {
            background-color: rgba(229, 62, 62, 0.2); 
            color: #f56565; 
            border-color: rgba(229, 62, 62, 0.4);
        }
        .action-button.delete:hover {
            background-color: rgba(229, 62, 62, 0.4);
            color: white;
        }
        .action-button i {
            margin: 0; 
        }
        .empty-quest-gif { 
            width: 100px; 
            height: 100px; 
            margin: 0 auto 0.75rem auto; 
            opacity: 0.8; 
            border-radius: 0.25rem; 
        }
        .url-input-profile {
            font-size: 0.875rem;
            color: var(--text-color-light);
            background-color: rgba(59, 89, 152, 0.8);
            border: 1px solid var(--himmel-blue-dark);
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
            box-shadow: sm;
        }
        .url-input-profile:focus {
            outline: none;
            ring: 2px;
            ring-color: var(--himmel-blue-primary);
            border-color: var(--himmel-blue-primary);
        }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="top-header flex items-center justify-between">
        <h1 class="logo-text font-pixel">Unemployment's Quest</h1>
        <div class="flex items-center space-x-3">
            <button id="loginBtn" class="capsule-button-modern capsule-button-secondary">Login</button>
            <button id="logoutBtn" class="capsule-button-modern capsule-button-secondary hidden">Logout</button>
            <button id="openAddQuestModalBtn" class="capsule-button-modern hidden">
                <i class="fas fa-plus mr-2 text-xs"></i>Add Quest 
            </button>
        </div>
    </header>

    <hr class="border-t border-white opacity-20 w-full">

    <main class="main-content-wrapper flex-1 overflow-y-auto">
        
        <section class="mb-6 p-4 rounded-lg" style="background-color: rgba(30, 49, 82, 0.6);">
            <div class="flex flex-col md:flex-row items-center md:items-start md:space-x-6 space-y-4 md:space-y-0">
                <div class="flex-shrink-0 text-center">
                    <img id="playerProfilePic" src="https://placehold.co/100x100/4a69a5/e0e8ff?text=P" alt="Foto Profil" class="profile-pic mx-auto mb-2">
                    <p class="text-white font-pixel level-text">Level: <span id="playerLevel">1</span></p>
                    <div class="mt-1 w-full max-w-[100px] mx-auto">
                        <div id="xpBarContainer" class="xp-bar-container">
                            <div id="xpBar" class="xp-bar" style="width: 0%;"></div>
                        </div>
                        <p id="xpText" class="text-xs text-slate-300 mt-0.5">0/100 XP</p>
                    </div>
                </div>

                <div class="flex-grow text-center md:text-left player-info-section">
                    <div id="usernameContainer">
                        <h3 id="playerUsername" class="username font-pixel">Nama Pengguna</h3>
                    </div>
                    <input type="text" id="usernameEditInput" class="username-edit-input font-pixel hidden w-full" placeholder="Username baru...">
                    <button id="saveUsernameBtn" class="capsule-button-modern capsule-button-secondary text-xs py-1 px-2 mt-1 hidden">Simpan Username</button>
                    
                    <p id="playerCustomId" class="user-id">Player ID: -</p>
                    <div id="bioContainer">
                        <p id="playerBio" class="user-bio">Klik untuk edit bio...</p>
                    </div>
                    <textarea id="bioEditInput" class="bio-edit-input hidden w-full" placeholder="Masukkan bio baru..."></textarea>
                    <button id="saveBioBtn" class="capsule-button-modern capsule-button-secondary text-xs py-1 px-2 mt-1 hidden">Simpan Bio</button>
                </div>


                <div class="flex-shrink-0 text-center">
                    <div class="p-3 rounded-md" style="background-color: rgba(42, 64, 101, 0.7);">
                        <h3 class="text-sm font-medium text-[var(--himmel-blue-lighter)] mb-1.5">Streak Harian</h3>
                        <div class="streak-balls-container mb-1">
                            </div>
                        <p>
                            <span id="totalStreakCount" class="streak-number">0</span>
                            <span class="streak-text"> Hari</span>
                        </p>
                    </div>
                    <div id="currentTimeDisplay" class="time-display text-center">
                        Memuat waktu...
                    </div>
                </div>
            </div>
        </section>

        <nav class="flex flex-col sm:flex-row justify-center items-center gap-3 mb-6">
            <a href="#" class="quest-type-nav-card w-full sm:w-auto" data-quest-type="daily">
                <i class="fas fa-leaf text-green-400"></i>
                <span class="font-medium">Daily Quest</span>
            </a>
            <a href="#" class="quest-type-nav-card w-full sm:w-auto" data-quest-type="main">
                <i class="fas fa-crown text-yellow-400"></i>
                <span class="font-medium">Main Quest</span>
            </a>
            <a href="#" class="quest-type-nav-card w-full sm:w-auto" data-quest-type="side">
                <i class="fas fa-feather-alt text-sky-400"></i>
                <span class="font-medium">Side Quest</span>
            </a>
        </nav>

        <div>
            <h3 id="currentQuestTypeTitle" class="text-2xl md:text-3xl font-semibold text-white text-center font-pixel">Pilih Kategori Quest</h3>
            <div id="questDisplayArea" class="w-full quest-list-container"> 
                <p class="text-center text-slate-400 italic py-8 col-span-full">Silakan login untuk melihat atau menambah quest.</p>
            </div>
        </div>
    </main>

    <div id="loginSignupModal" class="fixed inset-0 modal items-center justify-center p-4 hidden z-50">
        <div class="modal-content p-6 w-full max-w-md">
            <h3 id="authModalTitle" class="modal-title mb-6 text-center text-white font-pixel">Login</h3>
            <form id="authForm" class="space-y-4">
                <div>
                    <label for="authUsernameInput" class="block text-sm font-medium text-slate-300 mb-1">Username:</label>
                    <input type="text" id="authUsernameInput" name="authUsernameInput" required class="text-sm mt-1 block w-full bg-[rgba(59,89,152,0.8)] border border-[var(--himmel-blue-dark)] rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-[var(--himmel-blue-primary)] focus:border-[var(--himmel-blue-primary)] text-white placeholder-slate-400">
                </div>
                <div>
                    <label for="authPassword" class="block text-sm font-medium text-slate-300 mb-1">Password:</label>
                    <input type="password" id="authPassword" name="authPassword" required class="text-sm mt-1 block w-full bg-[rgba(59,89,152,0.8)] border border-[var(--himmel-blue-dark)] rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-[var(--himmel-blue-primary)] focus:border-[var(--himmel-blue-primary)] text-white placeholder-slate-400">
                </div>
                <p id="authError" class="text-xs text-red-400 text-center"></p>
                <div class="flex flex-col space-y-3 pt-4">
                    <button type="submit" id="authSubmitBtn" class="capsule-button-modern w-full">Login</button>
                    <button type="button" id="switchAuthModeBtn" class="text-sm text-[var(--himmel-blue-lighter)] hover:text-white text-center">Belum punya akun? Sign Up</button>
                </div>
                 <button type="button" id="closeAuthModalBtn" class="capsule-button-modern capsule-button-secondary w-full mt-3">Batal</button>
            </form>
        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 modal items-center justify-center p-4 hidden z-50">
        <div class="modal-content p-6 w-full max-w-sm text-center">
            <h3 class="modal-title mb-4 text-white font-pixel">Kustomisasi Profil</h3>
            <img id="profileModalPic" src="https://placehold.co/150x150/4a69a5/e0e8ff?text=P" alt="Foto Profil Besar" class="profile-modal-pic mx-auto">
            
            <label for="profilePicUrlInputModal" class="block text-sm font-medium text-slate-300 mb-1 text-left">Link Foto Profil Baru:</label>
            <input type="url" id="profilePicUrlInputModal" placeholder="https://example.com/gambar.png" class="url-input-profile mb-3">
            <p id="profilePicError" class="text-xs text-red-400 text-center mb-3"></p>
            
            <button id="saveProfilePicBtn" class="capsule-button-modern w-full max-w-xs mx-auto mb-2">Simpan Foto</button>
            <button id="closeProfileModalBtn" class="capsule-button-modern capsule-button-secondary w-full max-w-xs mx-auto">Tutup</button>
        </div>
    </div>

    <div id="addQuestModal" class="fixed inset-0 modal items-center justify-center p-4 hidden z-50">
        <div class="modal-content p-6 w-full max-w-lg">
            <h3 class="modal-title mb-6 text-center text-white font-pixel">Tambah Quest Baru</h3>
            <form id="questForm" class="space-y-4">
                <div>
                    <label for="questName" class="block text-sm font-medium text-slate-300 mb-1">Nama Quest:</label>
                    <input type="text" id="questName" name="questName" required class="text-sm mt-1 block w-full bg-[rgba(59,89,152,0.8)] border border-[var(--himmel-blue-dark)] rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-[var(--himmel-blue-primary)] focus:border-[var(--himmel-blue-primary)] text-white placeholder-slate-400">
                </div>
                <div>
                    <label for="questXp" class="block text-sm font-medium text-slate-300 mb-1">XP:</label>
                    <input type="number" id="questXp" name="questXp" min="1" required class="text-sm mt-1 block w-full bg-[rgba(59,89,152,0.8)] border border-[var(--himmel-blue-dark)] rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-[var(--himmel-blue-primary)] focus:border-[var(--himmel-blue-primary)] text-white placeholder-slate-400">
                </div>
                <div>
                    <label for="questTypeModal" class="block text-sm font-medium text-slate-300 mb-1">Tipe Quest:</label>
                    <select id="questTypeModal" name="questTypeModal" class="text-sm mt-1 block w-full bg-[rgba(59,89,152,0.8)] border border-[var(--himmel-blue-dark)] rounded-md shadow-sm py-2.5 px-3 focus:outline-none focus:ring-2 focus:ring-[var(--himmel-blue-primary)] focus:border-[var(--himmel-blue-primary)] text-white">
                        <option value="daily">Daily</option>
                        <option value="main">Main</option>
                        <option value="side">Side</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="closeAddQuestModalBtn" class="capsule-button-modern capsule-button-secondary">Batal</button>
                    <button type="submit" class="capsule-button-modern">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="completionModal" class="fixed inset-0 modal items-center justify-center p-4 hidden z-50">
        <div class="modal-content p-6 w-full max-w-md text-center">
            <div class="text-5xl mb-4 modal-icon"> <i class="fas fa-trophy text-yellow-400"></i> </div>
            <h3 class="modal-title mb-3 font-pixel" id="completionModalTitle">Quest Selesai!</h3>
            <p id="completionMessage" class="text-slate-300 mb-6 text-sm">Selamat! Anda telah menyelesaikan quest.</p>
            <button id="closeCompletionModalButton" class="capsule-button-modern w-full">
                Lanjutkan!
            </button>
        </div>
    </div>

    <div id="deleteConfirmModal" class="fixed inset-0 modal items-center justify-center p-4 hidden z-50">
        <div class="modal-content p-6 w-full max-w-sm text-center">
            <h3 class="modal-title mb-4 text-white font-pixel">Konfirmasi Hapus</h3>
            <p id="deleteConfirmMessage" class="text-slate-300 mb-6 text-sm">Anda yakin ingin menghapus quest "<span id="questNameToDelete" class="font-semibold"></span>"? Tindakan ini tidak dapat diurungkan.</p>
            <div class="flex justify-center space-x-3">
                <button id="cancelDeleteBtn" class="capsule-button-modern capsule-button-secondary">Batal</button>
                <button id="confirmDeleteBtn" class="capsule-button-modern capsule-button-danger">Hapus</button>
            </div>
        </div>
    </div>


    <script type="module">
        // 1. CONFIGURATION (API_BASE_URL for your backend)
        const API_BASE_URL = 'http://localhost:3001/api'; 
        console.log("API_BASE_URL set to:", API_BASE_URL);

        // 2. GLOBAL VARIABLES & STATE
        let userId = null; 
        console.log("Global userId declared, initial value:", userId);

        let localPlayerState = { 
            _id: null, 
            xp: 0, 
            level: 1, 
            dailyStreak: 0, 
            lastStreakUpdateDate: null, 
            daysCompletedThisCycle: 0, 
            displayName: "Guest", 
            profilePicture: null,
            bio: "Klik untuk edit bio...",
            customPlayerId: null 
        };
        let allQuests = []; 
        let currentQuestFilter = "daily"; 
        const XP_PER_LEVEL = 100;
        let currentJakartaDate = null; 
        const timeApiUrl = "https://timeapi.io/api/time/current/zone?timeZone=Asia%2FJakarta";
        let accessToken = localStorage.getItem('accessToken'); 
        console.log("Initial accessToken from localStorage:", accessToken);


        // 3. DOM Elements
        const playerUsernameEl = document.getElementById('playerUsername');
        const usernameContainerEl = document.getElementById('usernameContainer');
        const usernameEditInputEl = document.getElementById('usernameEditInput');
        const saveUsernameBtnEl = document.getElementById('saveUsernameBtn'); 
        const playerCustomIdEl = document.getElementById('playerCustomId'); 
        const playerBioEl = document.getElementById('playerBio');
        const bioContainerEl = document.getElementById('bioContainer');
        const bioEditInputEl = document.getElementById('bioEditInput');
        const saveBioBtnEl = document.getElementById('saveBioBtn'); 

        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginSignupModal = document.getElementById('loginSignupModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authForm = document.getElementById('authForm');
        const authUsernameInputEl = document.getElementById('authUsernameInput'); 
        const authPasswordInput = document.getElementById('authPassword');
        const authErrorEl = document.getElementById('authError');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const switchAuthModeBtn = document.getElementById('switchAuthModeBtn');
        const closeAuthModalBtn = document.getElementById('closeAuthModalBtn');
        let isLoginMode = true;

        const currentQuestTypeTitleEl = document.getElementById('currentQuestTypeTitle');
        const streakBallsContainer = document.querySelector('.streak-balls-container');
        const totalStreakCountEl = document.getElementById('totalStreakCount');
        const playerProfilePicEl = document.getElementById('playerProfilePic');
        const playerLevelEl = document.getElementById('playerLevel'); 
        const xpBarEl = document.getElementById('xpBar'); 
        const xpTextEl = document.getElementById('xpText'); 
        const currentTimeDisplayEl = document.getElementById('currentTimeDisplay'); 
        
        const questForm = document.getElementById('questForm');
        const questNameInput = document.getElementById('questName');
        const questXpInput = document.getElementById('questXp');
        const questTypeModalInput = document.getElementById('questTypeModal');
        const questDisplayArea = document.getElementById('questDisplayArea');

        const addQuestModal = document.getElementById('addQuestModal');
        const openAddQuestModalBtn = document.getElementById('openAddQuestModalBtn');
        const closeAddQuestModalBtn = document.getElementById('closeAddQuestModalBtn');
        
        const completionModal = document.getElementById('completionModal'); 
        const completionModalTitleEl = document.getElementById('completionModalTitle');
        const completionMessageEl = document.getElementById('completionMessage'); 
        const completionModalIconEl = completionModal.querySelector('.modal-icon i');
        const closeCompletionModalButton = document.getElementById('closeCompletionModalButton');

        const profileModalEl = document.getElementById('profileModal');
        const profileModalPicEl = document.getElementById('profileModalPic');
        const profilePicUrlInputModalEl = document.getElementById('profilePicUrlInputModal'); 
        const saveProfilePicBtnEl = document.getElementById('saveProfilePicBtn'); 
        const profilePicErrorEl = document.getElementById('profilePicError');
        const closeProfileModalBtnEl = document.getElementById('closeProfileModalBtn');

        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const questNameToDeleteEl = document.getElementById('questNameToDelete');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        let questIdToDelete = null;

        // Tone.js
        const synth = new Tone.Synth({
            oscillator: { type: "sine" }, 
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.5 }
        }).toDestination();
        const playSound = (note, duration = "8n", timeOffset = 0) => {
            if (Tone.context.state !== 'running') {
                Tone.start().then(() => {
                    synth.triggerAttackRelease(note, duration, Tone.now() + timeOffset);
                }).catch(e => console.error("Error starting Tone.js context:", e));
            } else {
                synth.triggerAttackRelease(note, duration, Tone.now() + timeOffset);
            }
        };
        const successSound = () => { playSound("E5"); playSound("G5", "8n", 0.1); };
        const levelUpSound = () => { playSound("C4"); playSound("E4", "8n", 0.15); playSound("G4", "4n", 0.3); playSound("C5", "2n", 0.5);};
        const uncheckSound = () => { playSound("C3"); playSound("A2", "8n", 0.1);}; 
        const deleteSound = () => { playSound("A3", "4n"); playSound("F3", "4n", 0.15);}; 
        const openModalSound = () => playSound("C4", "16n");
        const closeModalSound = () => playSound("A3", "16n");
        const errorSound = () => { playSound("F#3", "8n"); playSound("F3", "8n", 0.1); };

        // --- Fungsi Helper untuk API Call ---
        async function fetchAPI(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }
            const config = { method, headers };
            if (body) {
                config.body = JSON.stringify(body);
            }
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                if (!response) {
                    console.warn(`Fetch to ${API_BASE_URL}${endpoint} failed. Is the backend server running at the correct address?`);
                    throw new Error("Tidak bisa terhubung ke server. Pastikan backend berjalan.");
                }
                const data = await response.json(); 
                if (!response.ok) {
                    const errorMessage = data.message || response.statusText || `Error ${response.status}`;
                    console.error(`API Error (${response.status}) on ${method} ${endpoint}:`, errorMessage, data);
                    throw new Error(errorMessage);
                }
                return data;
            } catch (error) {
                console.error(`Network or parsing error on ${method} ${endpoint}:`, error);
                if (error.message.toLowerCase().includes('failed to fetch')) {
                    throw new Error("Gagal terhubung ke server. Pastikan backend berjalan dan URL API benar.");
                }
                if (error instanceof Error) {
                    throw error;
                } else {
                    throw new Error(String(error.message || error || 'Request failed'));
                }
            }
        }
        
        // --- UI UPDATE FUNCTIONS (Defined before use) ---
        function renderStreakBalls() {
            if (!streakBallsContainer || !totalStreakCountEl) return;
            streakBallsContainer.innerHTML = '';
            const ballsToShow = 7;
            for (let i = 0; i < ballsToShow; i++) {
                const ball = document.createElement('div');
                ball.classList.add('streak-ball');
                if (localPlayerState.dailyStreak > 0 && i < localPlayerState.daysCompletedThisCycle) {
                    ball.classList.add('filled');
                }
                streakBallsContainer.appendChild(ball);
            }
            totalStreakCountEl.textContent = localPlayerState.dailyStreak || 0;
        }
        
        function updatePlayerUI() {
            console.log("updatePlayerUI called. Current userId:", userId, "PlayerState:", localPlayerState);
            if (!localPlayerState) return;
            if(playerUsernameEl) playerUsernameEl.textContent = localPlayerState.displayName || "Guest";
            if(playerCustomIdEl) playerCustomIdEl.textContent = localPlayerState.customPlayerId ? `Player ID: ${localPlayerState.customPlayerId}` : (userId ? "Player ID: -" : "");
            if(playerBioEl) playerBioEl.textContent = localPlayerState.bio || (userId ? "Klik untuk edit bio..." : "");
            if(playerLevelEl) playerLevelEl.textContent = localPlayerState.level || 1;

            const picInitial = localPlayerState.displayName ? localPlayerState.displayName.charAt(0).toUpperCase() : (userId ? "U" : "G");
            const placeholderPic = `https://placehold.co/100x100/4a69a5/e0e8ff?text=${picInitial}`;
            if(playerProfilePicEl) playerProfilePicEl.src = localPlayerState.profilePicture || placeholderPic;
            if(profileModalPicEl) profileModalPicEl.src = localPlayerState.profilePicture || `https://placehold.co/150x150/4a69a5/e0e8ff?text=${picInitial}`;

            const currentXP = localPlayerState.xp || 0;
            const xpPercentage = Math.min((currentXP / XP_PER_LEVEL) * 100, 100);
            if(xpBarEl) xpBarEl.style.width = `${xpPercentage}%`;
            if(xpTextEl) xpTextEl.textContent = `${currentXP}/${XP_PER_LEVEL} XP`;

            renderStreakBalls();
        }

        function getQuestDisplayIconClass(type) {
            switch (type) {
                case "daily": return "fas fa-leaf text-green-400";
                case "main": return "fas fa-crown text-yellow-400";
                case "side": return "fas fa-feather-alt text-sky-400";
                default: return "fas fa-question-circle text-gray-400";
            }
        }

        function renderQuests() {
            if (!questDisplayArea) return;
            if (!accessToken && !userId) { 
                questDisplayArea.innerHTML = '<p class="text-center text-slate-400 italic py-8 col-span-full">Silakan login untuk melihat atau menambah quest.</p>';
                return;
            }

            const filteredQuests = allQuests.filter(q => q.type === currentQuestFilter);
            filteredQuests.sort((a, b) => {
                if (a.isCompleted !== b.isCompleted) return a.isCompleted ? 1 : -1;
                const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0); 
                const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0); 
                return dateB - dateA; 
            });

            if (filteredQuests.length === 0) {
                questDisplayArea.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <img src="https://i.imgur.com/BL0ODHS.gif" alt="Frieren Kuru Kuru GIF" class="empty-quest-gif">
                        <p class="text-slate-400 italic">Tidak ada quest ${currentQuestFilter} saat ini. Tambahkan satu!</p>
                    </div>`;
                return;
            }

            questDisplayArea.innerHTML = '';
            filteredQuests.forEach(quest => {
                const card = document.createElement('div');
                card.className = `quest-card ${quest.isCompleted ? 'opacity-60' : ''}`;
                card.innerHTML = `
                    <div class="quest-card-content flex items-start">
                        <div class="quest-card-icon-wrapper">
                            <i class="${getQuestDisplayIconClass(quest.type)}"></i>
                        </div>
                        <div class="flex-grow">
                            <h4 class="font-semibold text-white mb-1 ${quest.isCompleted ? 'line-through' : ''}">${quest.name}</h4>
                            <p class="text-xs text-slate-400">XP: ${quest.xp}</p>
                        </div>
                    </div>
                    <div class="quest-card-actions">
                        <button class="action-button ${quest.isCompleted ? 'complete' : ''}" data-quest-id="${quest._id}" data-action="toggle">
                            <i class="fas ${quest.isCompleted ? 'fa-undo' : 'fa-check'}"></i>
                        </button>
                        <button class="action-button delete" data-quest-id="${quest._id}" data-quest-name="${quest.name}" data-action="delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                questDisplayArea.appendChild(card);
            });

            questDisplayArea.querySelectorAll('.action-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const id = event.currentTarget.dataset.questId;
                    const action = event.currentTarget.dataset.action;
                    if (action === 'toggle') handleToggleCompleteQuest(id);
                    else if (action === 'delete') handleDeleteQuestPrompt(id, event.currentTarget.dataset.questName);
                });
            });
        }
        
        function resetUIForLogout() {
            console.log("Resetting UI for logout. Current userId before reset:", userId); 
            userId = null; 
            accessToken = null; 
            localStorage.removeItem('accessToken'); 
            localPlayerState = { _id: null, xp: 0, level: 1, dailyStreak: 0, lastStreakUpdateDate: null, daysCompletedThisCycle: 0, displayName: "Guest", profilePicture: null, bio: "Klik untuk edit bio...", customPlayerId: null };
            allQuests = [];
            updatePlayerUI(); 
            renderQuests(); 
            if(loginBtn) loginBtn.classList.remove('hidden');
            if(logoutBtn) logoutBtn.classList.add('hidden');
            if(openAddQuestModalBtn) openAddQuestModalBtn.classList.add('hidden');
            if(currentQuestTypeTitleEl) currentQuestTypeTitleEl.textContent = "Pilih Kategori Quest";
        }

        // --- AUTHENTICATION (lanjutan) ---
        function toggleAuthModal(show, toLoginMode = true) {
            console.log("Toggling auth modal, show:", show, "isLoginMode:", toLoginMode); 
            if (loginSignupModal) { 
                if (show) {
                    isLoginMode = toLoginMode;
                    if(authModalTitle) authModalTitle.textContent = isLoginMode ? "Login" : "Sign Up";
                    if(authSubmitBtn) authSubmitBtn.textContent = isLoginMode ? "Login" : "Sign Up";
                    if(switchAuthModeBtn) switchAuthModeBtn.textContent = isLoginMode ? "Belum punya akun? Sign Up" : "Sudah punya akun? Login";
                    if(authErrorEl) authErrorEl.textContent = "";
                    if(authForm) authForm.reset(); 
                    loginSignupModal.classList.remove('hidden');
                    loginSignupModal.classList.add('flex');
                    console.log("Auth modal classes after show:", loginSignupModal.classList); 
                    openModalSound();
                } else {
                    loginSignupModal.classList.add('hidden');
                    loginSignupModal.classList.remove('flex');
                    if(authErrorEl) authErrorEl.textContent = ""; 
                    closeModalSound();
                }
            } else {
                console.error("Login/Signup modal element (loginSignupModal) NOT FOUND!"); 
            }
        }
        
        async function initializeUserSession() {
            if (!accessToken) { 
                console.log("initializeUserSession: No accessToken, resetting UI.");
                resetUIForLogout();
                return;
            }
            console.log("initializeUserSession: accessToken found, attempting to fetch user state.");

            try {
                if(loginBtn) loginBtn.classList.add('hidden');
                if(logoutBtn) logoutBtn.classList.remove('hidden');
                if(openAddQuestModalBtn) openAddQuestModalBtn.classList.remove('hidden');

                const userStateData = await fetchAPI('/user/state'); 
                updateLocalPlayerState(userStateData); 
                userId = localPlayerState._id; 
                console.log("User session initialized, userId:", userId);
                
                await fetchQuests(); 
                await fetchCurrentTimeAndTriggerDailyResetIfNeeded(); 
            } catch (error) {
                console.error("Gagal inisialisasi sesi user:", error.message);
                if (error.message.includes("401") || error.message.includes("403") || error.message.toLowerCase().includes("token")) { 
                    accessToken = null;
                    localStorage.removeItem('accessToken');
                    resetUIForLogout();
                    showCompletionModal("Sesi Anda telah berakhir atau tidak valid. Silakan login kembali.", false, "fa-exclamation-triangle text-orange-400", "Sesi Berakhir");
                } else {
                    showCompletionModal(`Error memuat data pengguna: ${error.message}`, false, "fa-exclamation-triangle text-red-500", "Error");
                }
            }
        }
        
        async function fetchQuests() { 
            if (!accessToken) {
                allQuests = [];
                renderQuests();
                return;
            }
            try {
                const questsData = await fetchAPI('/quests');
                allQuests = questsData.sort((a,b) => (a.isCompleted - b.isCompleted) || (new Date(a.createdAt) - new Date(b.createdAt)));
                renderQuests();
            } catch (error) {
                console.error("Gagal mengambil quests:", error);
                showCompletionModal(`Gagal memuat quest: ${error.message}`, false, "fa-exclamation-triangle text-red-500", "Error");
                allQuests = [];
                renderQuests();
            }
        }
        
        async function handleToggleCompleteQuest(questId) { 
            const questIndex = allQuests.findIndex(q => q._id === questId);
            if (questIndex === -1 || !accessToken) return;
            
            const originalQuest = { ...allQuests[questIndex] }; 

            allQuests[questIndex].isCompleted = !allQuests[questIndex].isCompleted;
            if (allQuests[questIndex].isCompleted) {
                localPlayerState.xp += allQuests[questIndex].xp;
            } else {
                localPlayerState.xp = Math.max(0, localPlayerState.xp - allQuests[questIndex].xp);
            }
            renderQuests(); 
            updatePlayerUI(); 

            try {
                const data = await fetchAPI(`/quests/${questId}/toggle`, 'PUT');
                allQuests[questIndex] = data.updatedQuest;
                updateLocalPlayerState(data.updatedUser); 
                
                if (data.updatedQuest.isCompleted) {
                    successSound();
                    showCompletionModal(`Quest "${data.updatedQuest.name}" selesai! +${data.updatedQuest.xp} XP.`);
                    if (data.updatedUser.level > (localPlayerState.level - (data.updatedQuest.xp / XP_PER_LEVEL) )) { 
                         levelUpSound();
                         showCompletionModal(`Selamat! Anda naik ke Level ${data.updatedUser.level}!`, true, 'fa-star text-yellow-300', 'Level Up!');
                    }
                } else {
                    uncheckSound();
                }
            } catch (error) {
                allQuests[questIndex] = originalQuest;
                await initializeUserSession(); 
                showCompletionModal(`Gagal update quest: ${error.message}`, false, "fa-exclamation-triangle text-red-500", "Error");
                errorSound();
            }
        }
        
        function handleDeleteQuestPrompt(id, name) { 
            questIdToDelete = id;
            if(questNameToDeleteEl) questNameToDeleteEl.textContent = name;
            if(deleteConfirmModal){
                deleteConfirmModal.classList.remove('hidden');
                deleteConfirmModal.classList.add('flex');
                openModalSound();
            }
        }
        
        async function loadPlayerState() { 
            console.warn("loadPlayerState is effectively replaced by data from backend via initializeUserSession.");
        }
        
        async function checkAndUpdateDailyStreak(isCompletionEvent = false) { /* ... (menggunakan localPlayerState) ... */ }
        async function checkLevelUp() { /* ... (menggunakan localPlayerState) ... */ }
        async function savePlayerState() { 
            if (!userId || !accessToken) return; // userId adalah _id dari MongoDB
            try {
                console.log("Attempting to save player state to backend:", localPlayerState);
                const profileDataToUpdate = {
                    displayName: localPlayerState.displayName,
                    bio: localPlayerState.bio,
                    profilePicture: localPlayerState.profilePicture
                };
                // Panggil API untuk update profile jika ada perubahan yang perlu disimpan ke backend
                // Ini biasanya dipanggil dari fungsi edit username/bio/profile pic
                // await fetchAPI('/user/profile', 'PUT', profileDataToUpdate);
                console.log("Player state save (simulated, actual save happens on specific actions).");
            } catch (error) {
                console.error("Error saving player state to backend:", error);
            }
        }
        async function resetDailyQuestsIfNeeded() { /* ... (seharusnya ditangani backend via /api/system/daily-reset) ... */ }
        function showCompletionModal(message, isLevelUp = false, iconClass = 'fa-trophy text-yellow-400', title = 'Quest Selesai!') { /* ... */ }
        
        async function fetchCurrentTimeAndTriggerDailyResetIfNeeded() {
            console.log("Fetching current time...");
            try {
                const response = await fetch(timeApiUrl);
                if (!response.ok) {
                    let errorBody = "Tidak bisa membaca body error";
                    try { errorBody = await response.text(); } catch (e) { /* ignore */ }
                    console.error(`HTTP error! status: ${response.status}, body: ${errorBody}. Gagal mengambil waktu dari API.`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const oldJakartaDate = currentJakartaDate;
                currentJakartaDate = data.date; 
                if (currentTimeDisplayEl) {
                    currentTimeDisplayEl.textContent = formatTimeApiData(data);
                }
                
                if (accessToken && (oldJakartaDate !== currentJakartaDate || (oldJakartaDate === null && currentJakartaDate !== null))) {
                    console.log("Tanggal berubah atau login pertama hari ini. Memicu daily reset di backend...");
                    try {
                        const resetResult = await fetchAPI('/system/daily-reset', 'POST');
                        console.log("Hasil daily reset dari backend:", resetResult);
                        await initializeUserSession(); 
                    } catch (resetError) {
                        console.error("Gagal memicu daily reset di backend:", resetError);
                        showCompletionModal(`Gagal melakukan reset harian: ${resetError.message}`, false, "fa-exclamation-triangle text-red-500", "Error");
                    }
                }
            } catch (error) {
                console.error("Gagal mengambil waktu dari API (fetchCurrentTime catch):", error.message); 
                const now = new Date();
                currentJakartaDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                let localTimeMessage = "Koneksi API waktu gagal. Waktu lokal: ";
                const localTimeOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' };
                try {
                    localTimeMessage += now.toLocaleTimeString('id-ID', localTimeOptions).replace('pukul', '-');
                } catch (e) {
                    localTimeMessage = "Koneksi API waktu gagal. Gagal format waktu lokal.";
                }
                if (currentTimeDisplayEl) {
                    currentTimeDisplayEl.textContent = localTimeMessage;
                }
                console.warn("Menggunakan waktu lokal sebagai fallback.");
                if (accessToken) { 
                    // await checkAndUpdateDailyStreak(false); 
                    // await savePlayerState(); 
                    // updatePlayerUI();
                }
            }
        }
        
        // --- EVENT LISTENERS & INITIALIZATION ---
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    console.log("Login button clicked from setupEventListeners"); 
                    toggleAuthModal(true, true);
                });
            }
            if (closeAuthModalBtn) {
                closeAuthModalBtn.addEventListener('click', () => toggleAuthModal(false));
            }
            if (switchAuthModeBtn) {
                switchAuthModeBtn.addEventListener('click', () => {
                    isLoginMode = !isLoginMode; 
                    if(authModalTitle) authModalTitle.textContent = isLoginMode ? "Login" : "Sign Up";
                    if(authSubmitBtn) authSubmitBtn.textContent = isLoginMode ? "Login" : "Sign Up";
                    if(switchAuthModeBtn) switchAuthModeBtn.textContent = isLoginMode ? "Belum punya akun? Sign Up" : "Sudah punya akun? Login";
                    if(authErrorEl) authErrorEl.textContent = "";
                    if(authForm) authForm.reset();
                });
            }
            if(authForm) { 
                authForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if(authErrorEl) authErrorEl.textContent = "";
                    if(authSubmitBtn) {
                        authSubmitBtn.disabled = true;
                        authSubmitBtn.textContent = isLoginMode ? "Logging in..." : "Signing up...";
                    }

                    const username = authUsernameInputEl.value.trim();
                    const password = authPasswordInput.value;

                    if (!username || !password) {
                        if(authErrorEl) authErrorEl.textContent = "Username dan password harus diisi.";
                        if(authSubmitBtn) {
                            authSubmitBtn.disabled = false;
                            authSubmitBtn.textContent = isLoginMode ? "Login" : "Sign Up";
                        }
                        errorSound();
                        return;
                    }
                    
                    const endpoint = isLoginMode ? '/auth/login' : '/auth/signup';
                    try {
                        const data = await fetchAPI(endpoint, 'POST', { username, password });
                        accessToken = data.accessToken;
                        localStorage.setItem('accessToken', accessToken);
                        updateLocalPlayerState(data.user); 
                        await initializeUserSession();
                        toggleAuthModal(false);
                        successSound();
                    } catch (error) {
                        if(authErrorEl) authErrorEl.textContent = error.message || "Terjadi kesalahan.";
                        errorSound();
                    } finally {
                        if(authSubmitBtn) {
                            authSubmitBtn.disabled = false;
                            authSubmitBtn.textContent = isLoginMode ? "Login" : "Sign Up";
                        }
                    }
                });
            }
            if(logoutBtn) { 
                logoutBtn.addEventListener('click', async () => {
                    accessToken = null;
                    localStorage.removeItem('accessToken');
                    resetUIForLogout();
                    playSound("A3", "8n");
                });
            }
            
            if (playerUsernameEl) {
                playerUsernameEl.addEventListener('click', () => {
                    if (!accessToken) return; 
                    usernameContainerEl.classList.add('hidden');
                    usernameEditInputEl.value = localPlayerState.displayName === "Guest" ? "" : localPlayerState.displayName;
                    usernameEditInputEl.classList.remove('hidden');
                    saveUsernameBtnEl.classList.remove('hidden');
                    usernameEditInputEl.focus();
                });
            }
            if (saveUsernameBtnEl) {
                saveUsernameBtnEl.addEventListener('click', async () => {
                    const newDisplayName = usernameEditInputEl.value.trim();
                    if (newDisplayName && newDisplayName !== localPlayerState.displayName) {
                        try {
                            const data = await fetchAPI('/user/profile', 'PUT', { displayName: newDisplayName });
                            updateLocalPlayerState(data.user); 
                            successSound();
                        } catch (error) {
                            showCompletionModal(`Gagal update username: ${error.message}`, false, "fa-exclamation-triangle text-red-500", "Error");
                            errorSound();
                        }
                    }
                    if(playerUsernameEl) playerUsernameEl.textContent = localPlayerState.displayName || "Pengguna";
                    usernameEditInputEl.classList.add('hidden');
                    saveUsernameBtnEl.classList.add('hidden');
                    usernameContainerEl.classList.remove('hidden');
                });
            }
            if(usernameEditInputEl){
                usernameEditInputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveUsernameBtnEl.click(); });
            }

            if (playerBioEl) { 
                playerBioEl.addEventListener('click', () => {
                    if (!accessToken) return;
                    bioContainerEl.classList.add('hidden');
                    bioEditInputEl.value = localPlayerState.bio === "Klik untuk edit bio..." ? "" : localPlayerState.bio;
                    bioEditInputEl.classList.remove('hidden');
                    saveBioBtnEl.classList.remove('hidden'); // Tombol save bio yang benar
                    bioEditInputEl.focus();
                });
            }
            
            const actualSaveBioButton = document.getElementById('saveBioBtn'); // Pastikan ID ini unik dan benar
            if (actualSaveBioButton) { 
                 actualSaveBioButton.addEventListener('click', async () => {
                    const newBio = bioEditInputEl.value.trim();
                    try {
                        const data = await fetchAPI('/user/profile', 'PUT', { bio: newBio });
                        updateLocalPlayerState(data.user);
                        successSound();
                    } catch (error) {
                        showCompletionModal(`Gagal update bio: ${error.message}`, false, "fa-exclamation-triangle text-red-500", "Error");
                        errorSound();
                    }
                    if(playerBioEl) playerBioEl.textContent = localPlayerState.bio || "Klik untuk edit bio...";
                    bioEditInputEl.classList.add('hidden');
                    actualSaveBioButton.classList.add('hidden'); 
                    if(bioContainerEl) bioContainerEl.classList.remove('hidden');
                });
            }


            if (playerProfilePicEl) { /* ... (sama) ... */ }
            if (saveProfilePicBtnEl) { /* ... (sama) ... */ }
            if (closeProfileModalBtnEl) { /* ... (sama) ... */ }
            if (openAddQuestModalBtn) { /* ... (sama) ... */ }
            if (closeAddQuestModalBtn) { /* ... (sama) ... */ }
            if (closeCompletionModalButton) { /* ... (sama) ... */ }
            document.querySelectorAll('.quest-type-nav-card').forEach(item => { /* ... (sama) ... */ });
            if (questForm) { /* ... (event listener submit questForm sudah ada) ... */ }
            if (deleteConfirmModal) {
                if (confirmDeleteBtn) { /* ... (event listener confirmDeleteBtn sudah ada) ... */ }
                if(cancelDeleteBtn) { /* ... (event listener cancelDeleteBtn sudah ada) ... */ }
            }
        }

        async function setupApplication() { 
            console.log("Setting up application..."); 
            resetUIForLogout(); 
            setupEventListeners(); 
            
            const initialActiveNavItem = document.querySelector('.quest-type-nav-card[data-quest-type="daily"]');
            if (initialActiveNavItem && currentQuestTypeTitleEl) {
                initialActiveNavItem.classList.add('active');
                currentQuestFilter = 'daily'; 
                currentQuestTypeTitleEl.textContent = `Daftar ${initialActiveNavItem.querySelector('span').textContent.trim()}`;
            }
           if(currentQuestTypeTitleEl) currentQuestTypeTitleEl.classList.remove('hidden');

            if (accessToken) {
                console.log("Access token found in localStorage, attempting to initialize session.");
                await initializeUserSession();
            } else {
                console.log("No access token found, user is logged out. Fetching initial time.");
                await fetchCurrentTimeAndTriggerDailyResetIfNeeded(); 
            }
            
            setInterval(fetchCurrentTimeAndTriggerDailyResetIfNeeded, 60000 * 5); 
        }

        document.addEventListener('DOMContentLoaded', setupApplication); 

    </script>
</body>
</html>
